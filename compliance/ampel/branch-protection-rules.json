{
    "id": "AMPEL Policy for Branch Protection",
    "meta": {
        "frameworks": [
            { "id": "ComplyTime-Branch-Protection-Rules", "name": "ComplyTime Branch Protection Rules" }
        ]
    },
    "policies": [
        {
            "id": "SC-CODE-01.01",
            "meta": {
                "description": "Validate branch protection settings require pull requests via GitHub API or GitLab API",
                "controls": [
                    { "framework": "SC", "class": "SC-CODE", "id": "01" },
                    { "framework": "OSPS", "class": "OSPS-QA", "id": "07" }
                ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"update\") : false",
                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Direct pushes are disabled in default branch. PR required."
                    },
                    "error": {
                        "message": "Direct pushes are enabled so PRs are not required.",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Restrict updates\""
                    }
                }
            ]
        },
        {
            "id": "SC-CODE-02.01",
            "meta": {
                "description": "Validate minimum approval count (â‰¥1) and prevent self-approval via GitHub API or GitLab API",
                "controls": [
                    { "framework": "SC", "class": "SC-CODE", "id": "02" },
                    { "framework": "OSPS", "class": "OSPS-QA", "id": "07" }
                ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"pull_request\" && rule.parameters.required_approving_review_count >= 1) : false",
                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Minimum one non-author approval is required"
                    },
                    "error": {
                        "message": "PRs can be merged without peer review.",
                        "guidance": "Ensure the pull request rule requires at least one approving review."
                    }
                },
                {
                    "id": "02",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"pull_request\" && rule.parameters.dismiss_stale_reviews_on_push == true) : false",

                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "New, reviewable commits pushed will dismiss previous PR review approvals."
                    },
                    "error": {
                        "message": "Approvals are not dismissed when new commits are pushed.",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Dismiss stale pull request approvals when new commits are pushed\""
                    }
                },
                {
                    "id": "03",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"pull_request\" && rule.parameters.require_last_push_approval == true) : false",

                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "The most recent push must be approved by someone other than the person who pushed it."
                    },
                    "error": {
                        "message": "The most recent reviewable push is not approved by someone other than the person who pushed it.",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Require approval of the most recent reviewable push\""
                    }
                }
            ]
        },
        {
            "id": "SC-CODE-03.01",
            "meta": {
                "description": "Validate force push blocking is enabled on protected branches via GitHub API or GitLab API",
                "controls": [
                    { "framework": "SC", "class": "SC-CODE", "id": "03" },
                    { "framework": "OSPS", "class": "OSPS-QA", "id": "07" }
                ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"non_fast_forward\") : false",
                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Force pushing is disabled in default branch."
                    },
                    "error": {
                        "message": "Force pushes can be sent to main branch",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Block force pushes\""
                    }
                }
            ]
        },
        {
            "id": "SC-CODE-04.01",
            "meta": {
                "description": "Validate admin bypass prevention is enabled via GitHub API or GitLab API",
                "controls": [
                    { "framework": "SC", "class": "SC-CODE", "id": "03" },
                    { "framework": "OSPS", "class": "OSPS-QA", "id": "07" }
                ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"non_fast_forward\") : false",
                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Force pushing is disabled in default branch."
                    },
                    "error": {
                        "message": "Force pushes can be sent to main branch",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Block force pushes\""
                    }
                }
            ]
        },
        {
            "id": "SC-CODE-05.01",
            "meta": {
                "description": "Validate code owner review requirements are enabled when CODEOWNERS file exists via GitHub API or GitLab API",
                "controls": [ { "framework": "SC", "class": "SC-CODE", "id": "05" } ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"pull_request\" && rule.parameters.require_code_owner_review == true) : false",

                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "CODEOWNER approval is required before merging"
                    },
                    "error": {
                        "message": "CODEOWNER approval is not required before merging",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Require review from Code Owners\""
                    }
                }
            ]
        }
    ]
}
